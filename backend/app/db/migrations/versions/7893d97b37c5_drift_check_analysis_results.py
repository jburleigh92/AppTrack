"""drift_check_analysis_results

Revision ID: 7893d97b37c5
Revises: b8b2edb7c5df
Create Date: 2025-12-16 20:42:38.915805

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '7893d97b37c5'
down_revision = 'b8b2edb7c5df'
branch_labels = None
depends_on = None

def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index('idx_analysis_queue_pending', table_name='analysis_queue', postgresql_where="((status)::text = 'pending'::text)")
    op.create_index('idx_analysis_queue_pending', 'analysis_queue', ['priority', 'created_at'], unique=False, postgresql_ops={'priority': 'DESC'}, postgresql_where="status = 'pending'")
    op.alter_column('analysis_results', 'application_id',
               existing_type=sa.UUID(),
               nullable=True)
    op.alter_column('analysis_results', 'created_at',
               existing_type=postgresql.TIMESTAMP(),
               type_=sa.DateTime(timezone=True),
               existing_nullable=False)
    op.drop_index('idx_applications_analysis_id', table_name='applications')
    op.drop_index('idx_applications_company_name', table_name='applications', postgresql_where='(is_deleted = false)')
    op.drop_index('idx_applications_created_at', table_name='applications', postgresql_where='(is_deleted = false)')
    op.drop_index('idx_applications_needs_review', table_name='applications', postgresql_where='((needs_review = true) AND (is_deleted = false))')
    op.drop_index('idx_applications_posting_id', table_name='applications')
    op.drop_index('idx_applications_search_gin', table_name='applications', postgresql_using='gin')
    op.drop_index('idx_applications_status', table_name='applications', postgresql_where='(is_deleted = false)')
    op.alter_column('job_postings', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('job_postings', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index('idx_p3_budget_day', table_name='p3_advisory_budget')
    op.drop_index('idx_p3_cache_signal', table_name='p3_advisory_cache')
    op.drop_index('idx_p3_signal_active', table_name='p3_advisory_signal')
    op.drop_index('idx_p3_signal_resume_job', table_name='p3_advisory_signal')
    op.alter_column('scraped_postings', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('scraped_postings', 'updated_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.drop_index('idx_scraper_queue_pending', table_name='scraper_queue', postgresql_where="((status)::text = 'pending'::text)")
    op.create_index('idx_scraper_queue_pending', 'scraper_queue', ['priority', 'created_at'], unique=False, postgresql_ops={'priority': 'DESC'}, postgresql_where="status = 'pending'")
    op.drop_index('idx_timeline_events_occurred_at', table_name='timeline_events')
    op.create_index('idx_timeline_events_occurred_at', 'timeline_events', ['occurred_at'], unique=False, postgresql_ops={'occurred_at': 'DESC'})
    # ### end Alembic commands ###

def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_index('idx_timeline_events_occurred_at', table_name='timeline_events', postgresql_ops={'occurred_at': 'DESC'})
    op.create_index('idx_timeline_events_occurred_at', 'timeline_events', [sa.text('occurred_at DESC')], unique=False)
    op.drop_index('idx_scraper_queue_pending', table_name='scraper_queue', postgresql_ops={'priority': 'DESC'}, postgresql_where="status = 'pending'")
    op.create_index('idx_scraper_queue_pending', 'scraper_queue', [sa.text('priority DESC'), 'created_at'], unique=False, postgresql_where="((status)::text = 'pending'::text)")
    op.alter_column('scraped_postings', 'updated_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('scraped_postings', 'created_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.create_index('idx_p3_signal_resume_job', 'p3_advisory_signal', ['resume_id', 'job_posting_id'], unique=False)
    op.create_index('idx_p3_signal_active', 'p3_advisory_signal', ['is_active'], unique=False)
    op.create_index('idx_p3_cache_signal', 'p3_advisory_cache', ['signal_id'], unique=False)
    op.create_index('idx_p3_budget_day', 'p3_advisory_budget', ['budget_day'], unique=False)
    op.alter_column('job_postings', 'updated_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.alter_column('job_postings', 'created_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               existing_server_default=sa.text('now()'))
    op.create_index('idx_applications_status', 'applications', ['status'], unique=False, postgresql_where='(is_deleted = false)')
    op.create_index('idx_applications_search_gin', 'applications', [sa.text("to_tsvector('english'::regconfig, (((company_name::text || ' '::text) || job_title::text) || ' '::text) || COALESCE(notes, ''::text))")], unique=False, postgresql_using='gin')
    op.create_index('idx_applications_posting_id', 'applications', ['posting_id'], unique=False)
    op.create_index('idx_applications_needs_review', 'applications', ['needs_review'], unique=False, postgresql_where='((needs_review = true) AND (is_deleted = false))')
    op.create_index('idx_applications_created_at', 'applications', [sa.text('created_at DESC')], unique=False, postgresql_where='(is_deleted = false)')
    op.create_index('idx_applications_company_name', 'applications', ['company_name'], unique=False, postgresql_where='(is_deleted = false)')
    op.create_index('idx_applications_analysis_id', 'applications', ['analysis_id'], unique=False)
    op.alter_column('analysis_results', 'created_at',
               existing_type=sa.DateTime(timezone=True),
               type_=postgresql.TIMESTAMP(),
               existing_nullable=False)
    op.alter_column('analysis_results', 'application_id',
               existing_type=sa.UUID(),
               nullable=False)
    op.drop_index('idx_analysis_queue_pending', table_name='analysis_queue', postgresql_ops={'priority': 'DESC'}, postgresql_where="status = 'pending'")
    op.create_index('idx_analysis_queue_pending', 'analysis_queue', [sa.text('priority DESC'), 'created_at'], unique=False, postgresql_where="((status)::text = 'pending'::text)")
    # ### end Alembic commands ###

